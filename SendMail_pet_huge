task.spawn(function() 

getgenv().Settings = {
    ["list_pet"] = {

["Huge Chill Bunny"] 	= {Soluong_Yeu_cau = 0},
["Golden Huge Chill Bunny"] 	= {Soluong_Yeu_cau = 0},

["Huge Telescope Owl"] 	= {Soluong_Yeu_cau = 0},
["Golden Huge Telescope Owl"] 	= {Soluong_Yeu_cau = 0},

["Huge Runebound Bobcat"] 	= {Soluong_Yeu_cau = 0},
["Golden Huge Runebound Bobcat"] 	= {Soluong_Yeu_cau = 0},

},
   
}


ds_nguoi_nhan_pet = {"sijmongirthss", "Ash3rP0w3rPanda2018", "soystaylan5", "dreddyewele60", "1971Nowak3135", "mcconchifredjeyo", "ecclweltst", "killedsanthi85", "tamuleviazulayv", "hegemangaltieri81"}


-- HÃ m kiá»ƒm tra tÃªn cÃ³ chá»©a tá»« khÃ³a
function Kiem_tra_ten_co_them_tu_la_(itemName)
    local SH_find = false
    local PT_find = false
    local TN_find = false    
    local category_find = false
	
    -- Kiá»ƒm tra náº¿u itemName cÃ³ tá»« "Shiny"
    if string.find(itemName, "Shiny") then
        SH_find = true
        itemName = string.gsub(itemName, "Shiny ", "") -- Loáº¡i bá» tá»« "Shiny"
        warn("SH_find true")
    end

    -- Kiá»ƒm tra náº¿u itemName cÃ³ tá»« "Golden"
    if string.find(itemName, "Golden") then
        PT_find = 1
        itemName = string.gsub(itemName, "Golden ", "") -- Loáº¡i bá» tá»« "Golden"
        warn("PT_find 1")
    end

    -- Kiá»ƒm tra náº¿u itemName cÃ³ tá»« "Rainbow"
    if string.find(itemName, "Rainbow") then
        PT_find = 2
        itemName = string.gsub(itemName, "Rainbow ", "") -- Loáº¡i bá» tá»« "Rainbow"
        warn("PT_find 2")
    end

    -- Kiá»ƒm tra náº¿u itemName cÃ³ tá»« "Shiny Golden"
    if string.find(itemName, "Shiny Golden") then
        SH_find = true
        PT_find = 1
        itemName = string.gsub(itemName, "Shiny Golden ", "") -- Loáº¡i bá» tá»« "Shiny Golden"
        warn("PT_find 1 SH_find true")
    end

    -- Kiá»ƒm tra náº¿u itemName cÃ³ tá»« "Shiny Rainbow"
    if string.find(itemName, "Shiny Rainbow") then
        SH_find = true
        PT_find = 2
        itemName = string.gsub(itemName, "Shiny Rainbow ", "") -- Loáº¡i bá» tá»« "Shiny Rainbow"
        warn("PT_find 2 SH_find true")
    end

    -- Kiá»ƒm tra náº¿u itemName cÃ³ tá»« "TNx"
    local tnMatch = itemName:match("TN(%d)")  -- TÃ¬m kiáº¿m "TN" kÃ¨m má»™t sá»‘
    if tnMatch then
        TN_find = tonumber(tnMatch)  -- GÃ¡n giÃ¡ trá»‹ cá»§a TN_find
        itemName = string.gsub(itemName, " TN%d", "")  -- Loáº¡i bá» pháº§n "TNx" khá»i itemName
    end

    -- Kiá»ƒm tra category
    if string.find(itemName, "Potion") then
        category_find = "Potion"
        itemName = string.gsub(itemName, "Potion ", "") -- Loáº¡i bá» tá»« "Potion"
        warn("category Potion")
    end
    if string.find(itemName, "Enchant") then
        category_find = "Enchant"
        itemName = string.gsub(itemName, "Enchant ", "") -- Loáº¡i bá» tá»« "Enchant"
        warn("category Enchant")
    end
	if string.find(itemName, "XPPotion") then
        category_find = "XPPotion"
        itemName = string.gsub(itemName, "XPPotion ", "") -- Loáº¡i bá» tá»« "XPPotion"
        warn("category XPPotion")
    end

    -- Tráº£ vá» táº¥t cáº£ cÃ¡c giÃ¡ trá»‹
    return itemName, SH_find, PT_find
end

-- HÃ m tÃ¬m trong tá»«ng báº£ng con cá»§a Inventory
local function findInInventorySubTable(subTable, itemName, PT_find, SH_find)
    if type(subTable) ~= "table" then return end

    -- Sá»­ dá»¥ng string.match Ä‘á»ƒ tÃ¬m chÃ­nh xÃ¡c itemName
    for uid, v in pairs(subTable) do
        if type(v) == "table" and v.id then
            -- Kiá»ƒm tra xem id cÃ³ khá»›p chÃ­nh xÃ¡c vá»›i itemName vÃ  PT_find, SH_find, TN_find
            if string.match(v.id, "^" .. itemName .. "$") then  -- DÃ¹ng string.match Ä‘á»ƒ tÃ¬m pháº§n chuá»—i chÃ­nh xÃ¡c
                local ok = true

                -- Kiá»ƒm tra Ä‘iá»u kiá»‡n PT_find náº¿u cÃ³
                if PT_find ~= false and v.pt ~= PT_find then
                    ok = false
                end
                if PT_find == false and v.pt == 1 then
                    ok = false
                end
                if PT_find == false and v.pt == 2 then
                    ok = false
                end
                -- Kiá»ƒm tra Ä‘iá»u kiá»‡n SH_find náº¿u cÃ³
                if SH_find == true and v.sh == nil then
                    ok = false 
                end
                if SH_find == false and v.sh == true then
                    -- Náº¿u SH_find lÃ  nil thÃ¬ chá»‰ cháº¥p nháº­n v.sh lÃ  nil
                    ok = false
                end

                -- Náº¿u táº¥t cáº£ Ä‘iá»u kiá»‡n Ä‘á»u thá»a mÃ£n, thÃªm vÃ o danh sÃ¡ch
                if ok then
                    table.insert(itemsFound, {
                        UID = uid,
                        ID = v.id,
                        PT = v.pt,
                        SH = v.sh,
                        TN = v.tn,
                        Count = tonumber(v._am) or 1,
                        Category = categoryName  -- ThÃªm category cho tá»«ng má»¥c
                    })
                end
            end
        end
    end
end

-- HÃ m kiá»ƒm tra vÃ  gá»­i pet
local function sendExcessPets()

	local ReplicatedStorage = game:GetService("ReplicatedStorage")
	local Client = ReplicatedStorage:WaitForChild("Library"):WaitForChild("Client")
	local Network = require(Client.Network)
	local SaveData = require(ReplicatedStorage.Library.Client.Save).Get()   

    -- Láº·p qua tá»«ng pet trong list_pet
    for petName, petData in pairs(getgenv().Settings["list_pet"]) do
        local itemName = petName
        local requiredAmount = petData.Soluong_Yeu_cau
        local itemName,SH_find, PT_find = Kiem_tra_ten_co_them_tu_la_(itemName)
        
        -- Reset láº¡i danh sÃ¡ch pet
        itemsFound = {}

        -- TÃ¬m trong Inventory
        findInInventorySubTable(SaveData.Inventory.Pet, itemName, PT_find, SH_find)
        
        -- Kiá»ƒm tra sá»‘ lÆ°á»£ng pet cÃ³ sáºµn trong kho
        local totalCount = 0
        for _, item in pairs(itemsFound) do
            if item.ID == itemName then
                totalCount = totalCount + item.Count
            end
        end

        -- Náº¿u sá»‘ lÆ°á»£ng pet cÃ³ trong kho nhiá»u hÆ¡n yÃªu cáº§u, gá»­i pet 
        if totalCount > requiredAmount then
            
            local randomRecipient = ds_nguoi_nhan_pet[math.random(1, #ds_nguoi_nhan_pet)]
            local message = string.format("Happy birthday %s! You received an excess pet: %s", randomRecipient, itemName)

            -- Láº·p qua vÃ  gá»­i pet
            local petSent = 0
            for _, item in pairs(itemsFound) do
				
                if item.ID == itemName and petSent < totalCount then
                    
                    -- Gá»­i pet
					wait(3)
					if string.find(itemName,"Huge") then
						--warn("Huge chi send 1")
						totalCount = 1
					end
					if requiredAmount > 0 then
						--warn("Giá»¯ láº¡i bn con")
						totalCount = totalCount - requiredAmount
					end
                    local success, err = pcall(function()
                        return Network.Invoke("Mailbox: Send", randomRecipient, message, "Pet", item.UID, totalCount)
                    end)
                    if success then
                        warn("âœ… ÄÃ£ gá»­i pet " .. itemName .. " cho " .. randomRecipient .. " vá»›i sá»‘ lÆ°á»£ng " .. totalCount)
                    else
                        warn("âŒ Lá»—i khi gá»­i pet " .. itemName .. ": " .. err)
                    end
                    
                end
            end
        else
            warn("âš ï¸ KhÃ´ng cÃ³ Ä‘á»§ pet " .. itemName .. " trong kho Ä‘á»ƒ gá»­i.")
        end
    end
end

-- Gá»i hÃ m gá»­i pet


local function _check_time_resetmail()

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Client = ReplicatedStorage:WaitForChild("Library"):WaitForChild("Client")
local SaveData = require(Client.Save).Get()

local mailboxResetTime = SaveData.MailboxResetTime
local mailLog = SaveData.MailLog
local sentCount = 0

-- Má»‘c 24h trÆ°á»›c reset
local windowStart = mailboxResetTime - 86400
local currentTime = os.time()

-- Äáº¿m sá»‘ thÆ° Ä‘Ã£ gá»­i trong khoáº£ng 24h trÆ°á»›c thá»i Ä‘iá»ƒm reset
for _, entry in pairs(mailLog or {}) do
    if entry.Type == "Sent" and entry.Timestamp >= windowStart and entry.Timestamp <= mailboxResetTime then
        sentCount = sentCount + 1
    end
end

-- TÃ­nh thá»i gian cÃ²n láº¡i Ä‘áº¿n lÃºc reset
local secondsRemaining = math.max(0, mailboxResetTime - currentTime)
local hours = math.floor(secondsRemaining / 3600)
local minutes = math.floor((secondsRemaining % 3600) / 60)
local seconds = math.floor(secondsRemaining % 60)

warn(string.format("â³ CÃ²n %02dh %02dm %02ds ná»¯a sáº½ reset lÆ°á»£t gá»­i thÆ°.", hours, minutes, seconds))
warn("ğŸ“® Sá»‘ thÆ° Ä‘Ã£ gá»­i trong 24h trÆ°á»›c reset:", sentCount)

-- Náº¿u quÃ¡ giá»›i háº¡n -> chá» Ä‘áº¿n khi reset
if sentCount >= 10 then
    warn("âš ï¸ ÄÃ£ gá»­i quÃ¡ giá»›i háº¡n 10 thÆ°! Äang chá» Ä‘áº¿n khi reset...")
    task.wait(secondsRemaining + 1)  -- Ä‘á»£i Ä‘áº¿n khi reset + 1 giÃ¢y an toÃ n
    warn("âœ… ÄÃ£ qua thá»i Ä‘iá»ƒm reset, cÃ³ thá»ƒ gá»­i tiáº¿p.")
end

end

_check_time_resetmail()


while true do
sendExcessPets()
wait(3600)
end


end)
