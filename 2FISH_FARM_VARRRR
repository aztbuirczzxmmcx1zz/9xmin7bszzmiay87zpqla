-- ⏳ Delay khởi đầu
task.wait(50)


local Save = require(game:GetService("ReplicatedStorage").Library.Client.Save)
local rank = Save.Get().Rank

if rank < 8 then
	return
end
-- ⚙️ Services
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer = Players.LocalPlayer

-- 🌍 PlaceIds
local PLACE_WORLD_4 = 140403681187145
local PLACE_FISHING = 119454325063278 	--95635359880599
local PLACE_FARM = 95635359880599 		--119454325063278

-- 📂 Đọc file comboEventLog.json an toàn
local function readComboLog()
	for _ = 1, 3 do
		local success, data = pcall(readfile, "comboEventLog.json")
		if success and data then
			local ok, decoded = pcall(HttpService.JSONDecode, HttpService, data)
			if ok and type(decoded) == "table" then return decoded end
		end
		task.wait(1)
	end
	return nil
end

-- 🔁 Teleport Functions
local function serverhopTo(placeId)
	TeleportService:Teleport(placeId, LocalPlayer)
end

-- 🧭 Main Checker
task.spawn(function()
	while true do
		local logData = readComboLog()
		if not logData then
			warn("⚠️ Không đọc được file comboEventLog.json (3 lần).")
			break
		end

		local fishDone = logData.fish and logData.fish.done
		local farmDone = logData.farm and logData.farm.done

		if fishDone and farmDone then
			if game.PlaceId == PLACE_WORLD_4 then
				warn("✅ Đã ở World4 và đủ farm+fish. Dừng script.")
				break
			else
				warn("✅ Đủ farm+fish. Shutdown và Kick...")
				game:Shutdown()
				LocalPlayer:Kick("kick_done_2compo")
				break
			end
		elseif game.PlaceId == PLACE_WORLD_4 then
			if not farmDone then
				warn("➡️ Teleport đến FARM...")
				serverhopTo(PLACE_FARM)
			elseif not fishDone then
				warn("➡️ Teleport đến FISHING...")
				serverhopTo(PLACE_FISHING)
			else
				warn("⚠️ Lỗi logic không xác định.")
			end
		else
			warn("⏸ Chưa đủ combo, và không ở World4 → chờ...")
		end

		task.wait(30)
	end
end)

-- 🧨 Timeout nếu không vào World4 trong 20 phút
task.spawn(function()
	task.wait(30)
	if game.PlaceId == PLACE_WORLD_4 then return end

	warn("⏱ Đếm ngược 20 phút để vào World4...")
	task.wait(30 * 60)

	if game.PlaceId ~= PLACE_WORLD_4 then
		warn("❌ Timeout → Kick do không vào được World4.")
		game:Shutdown()
		LocalPlayer:Kick("kickcompo")
	end
end)
