repeat task.wait() until game:IsLoaded()

local placeId = 131952481663528
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-------------------------------------------------------
-- üßÆ H√†m ƒë·∫øm s·ªë ng∆∞·ªùi ch∆°i hi·ªán t·∫°i
-------------------------------------------------------
local function getPlayerCount()
	local count
	local ok, result = pcall(function()
		return #Players:GetPlayers()
	end)

	if ok and result then
		count = result
	else
		local tempCount = 0
		for _, player in ipairs(Players:GetChildren()) do
			if player:IsA("Player") then
				tempCount += 1
			end
		end
		count = tempCount
		warn("‚ö†Ô∏è Fallback GetPlayers(): s·ªë l∆∞·ª£ng ƒë·∫øm ƒë∆∞·ª£c:", count)
	end

	print("üë• S·ªë ng∆∞·ªùi trong server hi·ªán t·∫°i:", count)
	return count
end
-------------------------------------------------------
-- ‚ö° Teleport sang server √≠t ng∆∞·ªùi
-------------------------------------------------------
local function teleportToLeastPopulatedServer(placeId, runScriptOnJoin, retryLimit)
	retryLimit = retryLimit or 3
	local attempts = 0
	local cursor = nil

	while attempts < retryLimit do
		attempts += 1
		local validServers = {}
		local pagesChecked = 0

		repeat
			pagesChecked += 1
			local url = ('https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100'):format(placeId)
			if cursor then url = url .. '&cursor=' .. cursor end

			local ok, result = pcall(function()
				return HttpService:JSONDecode(game:HttpGet(url))
			end)

			if ok and result and result.data then
				for _, server in ipairs(result.data) do
					if server.playing and server.maxPlayers and server.playing > 0 and server.playing < server.maxPlayers then
						table.insert(validServers, server)
					end
				end
				cursor = result.nextPageCursor
			else
				warn(("‚ùå Kh√¥ng th·ªÉ l·∫•y server page (l·∫ßn %d), cursor: %s"):format(attempts, tostring(cursor)))
				cursor = nil
				break
			end

			task.wait(0.5)
		until #validServers >= 3 or not cursor or pagesChecked >= 9

		if #validServers > 0 then
			table.sort(validServers, function(a, b)
				return a.playing < b.playing
			end)

			local topCount = math.min(30, #validServers)
			local selectedServer = validServers[math.random(1, topCount)]
			if not selectedServer or not selectedServer.id then
				warn("‚ö†Ô∏è Server ch·ªçn kh√¥ng h·ª£p l·ªá, th·ª≠ l·∫°i...")
			else
				local teleportData = runScriptOnJoin and "RUNSCRIPT" or "NOSCRIPT"
				local ok, err = pcall(function()
					TeleportService:TeleportToPlaceInstance(placeId, selectedServer.id, LocalPlayer, { customData = teleportData })
				end)

				if ok then
					print(("‚úÖ Teleport th√†nh c√¥ng (ID: %s, %d/%d players)"):format(selectedServer.id, selectedServer.playing, selectedServer.maxPlayers))
					return true
				else
					warn(("‚ö†Ô∏è Teleport th·∫•t b·∫°i (L·∫ßn %d): %s"):format(attempts, tostring(err)))
				end
			end
		else
			warn(("üîÅ Kh√¥ng t√¨m ƒë∆∞·ª£c server h·ª£p l·ªá (l·∫ßn %d). Th·ª≠ l·∫°i..."):format(attempts))
		end

		task.wait(5)
	end
	-------------------------------------------------------
	-- ‚õî Teleport th·∫•t b·∫°i sau nhi·ªÅu l·∫ßn -> v·ªÅ place g·ªëc
	-------------------------------------------------------
	warn("‚õî Teleport th·∫•t b·∫°i sau " .. retryLimit .. " l·∫ßn th·ª≠!")

	if game.PlaceId ~= placeId then
		warn("üîÅ ƒêang kh√¥ng ·ªü ƒë√∫ng Place ID, teleport v·ªÅ g·ªëc...")
		local ok, err = pcall(function()
			TeleportService:Teleport(placeId, LocalPlayer)
		end)
		if not ok then
			warn("‚ùå Teleport v·ªÅ g·ªëc th·∫•t b·∫°i:", tostring(err))
		else
			print("‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu teleport v·ªÅ Place ID g·ªëc:", placeId)
		end
	end

	return false
end
-------------------------------------------------------
-- üïí Theo d√µi 3 ti·∫øng m·ªôt l·∫ßn
-------------------------------------------------------
local function monitorPlayerCount()
	while true do
		local count = getPlayerCount()
		if count <= 3 then
			print("üßò Server y√™n tƒ©nh (" .. count .. " ng∆∞·ªùi). Ki·ªÉm tra l·∫°i sau 6 ti·∫øng.")
		else
			warn("üö® Server ƒë√¥ng (" .. count .. " ng∆∞·ªùi)! Nh·∫£y sang server m·ªõi...")
			task.wait(3)
			teleportToLeastPopulatedServer(placeId, false, 5)
			wait(20)
			game:Shutdown()
			break
		end
		task.wait(21600) -- 6 ti·∫øng = 21600 gi√¢y
	end
end
-------------------------------------------------------
print("üîÅ B·∫Øt ƒë·∫ßu theo d√µi server Place ID:", placeId)
monitorPlayerCount()
