# Khai bao bien tuy chinh
WAIT_MINUTES = 720 # So phut cho (ban dau la 720 phut = 12 gio)

# pip install keyboard
# Can Windows OS de ham ctypes hoat dong

import time
import threading
import keyboard
import os
import shutil
import subprocess
import os 
from time import sleep 
import ctypes

# Cau hinh duong dan
DATA_FOLDER = r"C:\Users\ADMIN\Downloads\Yummyemu\YummyEmuPlayer\ChangeAcc"
EMURB_PATH = r"C:\Users\ADMIN\Downloads\Yummyemu\YummyEmuPlayer\EmuRB.exe"
EMURB_PROCESS_NAME = "EmuRB.exe"

# Bien kiem soat trang thai
running = False
thread = None

# ===============================================
# CAU TRUC CHO WriteConsoleInputW (Windows API)
# Phuong phap nhap moi - KHONG CAN FOCUS
# ===============================================

kernel32 = ctypes.windll.kernel32

# Event type
KEY_EVENT = 0x0001
# STD_INPUT_HANDLE = -10 (0xFFFFFFF6)
VK_RETURN = 0x0D # Virtual Key Code cho phim Enter

class KEY_EVENT_RECORD(ctypes.Structure):
    _fields_ = [
        ("bKeyDown", ctypes.c_int),
        ("wRepeatCount", ctypes.c_uint16),
        ("wVirtualKeyCode", ctypes.c_uint16),
        ("wVirtualScanCode", ctypes.c_uint16),
        ("uChar", ctypes.c_wchar),
        ("dwControlKeyState", ctypes.c_uint32)
    ]

class INPUT_RECORD(ctypes.Structure):
    _fields_ = [
        ("EventType", ctypes.c_uint16),
        ("KeyEvent", KEY_EVENT_RECORD)
    ]

# Thiet lap kieu tra ve va doi so cho cac ham WinAPI
kernel32.GetStdHandle.restype = ctypes.c_void_p
kernel32.WriteConsoleInputW.argtypes = (
    ctypes.c_void_p, 
    ctypes.POINTER(INPUT_RECORD), 
    ctypes.c_uint32, 
    ctypes.POINTER(ctypes.c_uint32)
)

def send_console_key(char):
    """Gui mot phim bat ky (bao gom \r cho Enter) vao console buffer."""
    hIn = kernel32.GetStdHandle(-10) # STD_INPUT_HANDLE = -10

    # Lay VK Code va char cho Enter
    if char == "\r":
        vk_code = VK_RETURN
        u_char = "\r"
    else:
        # Lay VK Code va char cho ky tu thuong
        vk_code = ord(char.upper())
        u_char = char

    record = INPUT_RECORD()
    record.EventType = KEY_EVENT

    # 1. Key down
    record.KeyEvent = KEY_EVENT_RECORD(
        bKeyDown=1,
        wRepeatCount=1,
        wVirtualKeyCode=vk_code,
        wVirtualScanCode=0,
        uChar=u_char,
        dwControlKeyState=0
    )
    bytes_written = ctypes.c_uint32(0)
    kernel32.WriteConsoleInputW(hIn, ctypes.byref(record), 1, ctypes.byref(bytes_written))

    # 2. Key up
    record.KeyEvent.bKeyDown = 0
    kernel32.WriteConsoleInputW(hIn, ctypes.byref(record), 1, ctypes.byref(bytes_written))
    
    # Nghi ngan de console xu ly input
    time.sleep(0.1)

def send_enter():
    send_console_key("\r")

# ===============================================
# LOGIC VONG LAP
# ===============================================

# Ham xoa file trong thu muc
def clear_folder(folder_path):
    # print(f"\nXoa cac file trong thu muc: {folder_path}") # Da han che print
    if not os.path.isdir(folder_path):
        # print(f"Loi: Thu muc khong ton tai: {folder_path}")
        return
    try:
        for filename in os.listdir(folder_path):
            file_path = os.path.join(folder_path, filename)
            if os.path.isfile(file_path):
                os.remove(file_path)
        # print(f"Da xoa hoan tat cac file trong {folder_path}")
    except Exception as e:
        # print(f"Loi khi xoa file: {e}")
        pass

# Ham dong ung dung
def close_application(process_name):
    # print(f"Dong ung dung: {process_name}")
    try:
        subprocess.run(
            f"taskkill /IM {process_name} /F",
            check=False, # Khong check de tranh Exception neu app khong chay
            shell=True,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        # print(f"Da gui lenh dong cho {process_name}")
    except:
        # print(f"Thong bao: Ung dung {process_name} co the khong chay hoac da dong.")
        pass

# Ham mo ung dung
def open_application(app_path):
    # print(f"Mo ung dung: {app_path}")
    if not os.path.isfile(app_path):
        # print(f"Loi: File ung dung khong ton tai: {app_path}")
        return

    # Lay thu muc chua file EmuRB.exe
    app_directory = os.path.dirname(app_path)
    
    try:
        subprocess.Popen([app_path], cwd=app_directory)
        # print(f"Da mo ung dung: {app_path}")
    except Exception as e:
        # print(f"Loi khi mo ung dung: {e}")
        pass

# Ham thuc hien chuoi hanh dong (1 lan)
def execute_single_action_sequence():
    global WAIT_MINUTES
    print("----------------------------------------")
    print("Bat dau chuoi hanh dong...")

    # 1. Dem nguoc 
    for i in range(WAIT_MINUTES, 0, -1):
        if not running: return # Thoat neu da STOP
        # Hien thi thoi gian con lai theo phut, cap nhat tren mot dong
        print(f"\rCho: Con lai {i} phut...", end='', flush=True) 
        sleep(60) # Cho 60 giay (1 phut)

    print("\rHoan thanh thoi gian cho. Bat dau thuc thi hanh dong.")
    
    # 2. Xoa het cac file trong thu muc data
    if not running: return
    clear_folder(DATA_FOLDER)
    sleep(1) 

    # 3. Dong ung dung EmuRB.exe roi cho 10s
    if not running: return
    close_application(EMURB_PROCESS_NAME)
    sleep(10)

    # 4. Mo lai ung dung EmuRB.exe roi cho 15s
    if not running: return
    open_application(EMURB_PATH)
    sleep(15)

    # 5. Thuc hien nut bam so 2 nghi 2s roi nhan phim Enter
    if not running: return
    send_console_key('2')
    sleep(2)
    send_enter()

    print("Da hoan thanh 1 chu trinh.")

# Vong lap chinh - Se chay lien tuc khi running=True
def run_loop():
    while running:
        try:
            execute_single_action_sequence()
            # Nghi ngan giua cac vong lap (vi du 5 giay)
            if running:
                sleep(5) 
        except Exception as e:
            # print(f"Loi trong vong lap: {e}")
            sleep(5) # Nghi de tranh lap loi nhanh

# Ham START
def start_loop_auto():
    global running, thread
    if not running:
        print("========================================")
        print("Script START - Bat dau vong lap tu dong.")
        print(f"Thoi gian cho ban dau: {WAIT_MINUTES} phut.")
        print("Nhan ESC de THOAT.")
        print("========================================")
        running = True
        # Bat dau vong lap trong mot thread moi
