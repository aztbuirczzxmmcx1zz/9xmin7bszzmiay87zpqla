_G.VAR_STOP_BLOCK_PARTY = false
_G.VAR_START_BLOCK_PARTY = true

if _G.VAR_BLOCK_PARTY then
	warn("‚õî Script ƒë√£ ƒë∆∞·ª£c ch·∫°y tr∆∞·ªõc ƒë√≥!")
	return
end

_G.VAR_BLOCK_PARTY = true
local isRunning = false

-- ‚öôÔ∏è D·ªãch v·ª• & Folder
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local player = game.Players.LocalPlayer
local TilesFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("Tiles")
local NLibrary = ReplicatedStorage.Library
local EggCmds = require(NLibrary.Client.EggCmds)
local Save = require(ReplicatedStorage.Library.Client.Save)
local Network = ReplicatedStorage:WaitForChild("Network")
local CustomEggsFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("CustomEggs")

-- üî¢ ƒê·∫øm t·ªïng s·ªë tile
local function getTotalTileCount()
	return #TilesFolder:GetChildren()
end

-- üß† D·ª´ng to√†n b·ªô khi b·ªã stop
local function waitUntilAllowed()
	while _G.VAR_STOP_BLOCK_PARTY and not _G.VAR_START_BLOCK_PARTY do
		warn("‚è∏ Script ƒëang b·ªã t·∫°m d·ª´ng b·ªüi _G.VAR_STOP_BLOCK_PARTY")
		task.wait(1)
	end
	if not _G.VAR_START_BLOCK_PARTY then
		isRunning = false
	end
end

function teleportTo(cf)
	local character = player.Character or player.CharacterAdded:Wait()
	local hrp = character:FindFirstChild("HumanoidRootPart")
	if hrp then
		hrp.CFrame = cf
	end
end

local function teleportToBlockParty()
	local Enter = workspace.__THINGS.Instances.BlockParty.Teleports.Enter

	-- üß≠ Teleport v√†o Block Party & ƒë·∫øn v·ªã tr√≠ c·ª• th·ªÉ
	teleportTo(Enter.CFrame + Vector3.new(0, 5, 0))
	task.wait(9)
	teleportTo(CFrame.new(16460, 2275, -21473))
end

teleportToBlockParty()

---------------- üß© LU·ªíNG 1: Mua tiles quanh plot ----------------
local function startAutoPurchase()

		local saveData = Save.Get()
		local tileRebirth = saveData.TileRebirth or 0
		local totalTiles = getTotalTileCount()
		if tileRebirth < 10 and totalTiles < 169 then
			Players.LocalPlayer:Kick("Sida")			
		end


end

---------------- üß© LU·ªíNG 2: Claim + Open + Unlock + Plant + Diamond ----------------
local function startTileHandler()
	local TilesInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Tiles_Invoke")
	local TilesFire = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Tiles_Fire")
	local delayPerTile = 0.05
	local delayPerCycle = 0.5

	while true do
		waitUntilAllowed()
		for _, tile in ipairs(TilesFolder:GetChildren()) do
			local tileId = tile.Name

			-- ‚úÖ Claim + Open (Tiles_Invoke)
			pcall(function() TilesInvoke:InvokeServer(tileId, "Claim") end)
			pcall(function() TilesInvoke:InvokeServer(tileId, "Open") end)

			-- ‚úÖ Claim + Unlock (Tiles_Fire)
			pcall(function() TilesFire:FireServer(tileId, "Claimed") end)
			pcall(function() TilesFire:FireServer(tileId, "Unlock") end)

			-- ‚úÖ Claim Plant[i] (1 -> 6)
			if tile:IsA("Model") or tile:IsA("Folder") then
				if tile:FindFirstChild("Plant1") then
					for i = 1, 6 do
						pcall(function()
							TilesInvoke:InvokeServer(tileId, "Claim", i)
						end)
						task.wait(0.05)
					end
				end

				-- ‚úÖ Claim Diamond
				if tile:FindFirstChild("Diamond") then
					pcall(function()
						TilesInvoke:InvokeServer(tileId, "Tile_ClaimDiamonds")
					end)
					task.wait(0.1)
				end
			end

			task.wait(delayPerTile)
		end

		task.wait(delayPerCycle)
	end
end
---------------- üß© LU·ªíNG 3: Hatch HUGE CHANCE ----------------
local currentChance = 0

local function startAutoHatchFarthest()


while true do
	if getTotalTileCount() >= 169 then
		break
	end
	wait(10)
end	

	-- ‚öôÔ∏è T·∫Øt animation m·ªü tr·ª©ng
	local successEggs, Eggs = pcall(function()
		return player:WaitForChild("PlayerScripts"):WaitForChild("Scripts"):WaitForChild("Game"):WaitForChild("Egg Opening Frontend")
	end)
	if successEggs and Eggs then
		pcall(function()
			getsenv(Eggs).PlayEggAnimation = function() return end
		end)
	end

	local function getHumanoidRootPart()
		local char = player.Character or player.CharacterAdded:Wait()
		return char:WaitForChild("HumanoidRootPart")
	end

	local function findFarthestEgg()
		local hrp = getHumanoidRootPart()
		local farthestEgg = nil
		local maxDistance = -1

		for _, egg in ipairs(CustomEggsFolder:GetChildren()) do
			if #egg.Name == 32 and egg:IsA("Model") and egg:FindFirstChild("Part") then
				local dist = (hrp.Position - egg.Part.Position).Magnitude
				if dist > maxDistance then
					farthestEgg = egg
					maxDistance = dist
				end
			end
		end

		return farthestEgg
	end
	local function handleRejoin()
		local Leave = workspace.__THINGS.Instances.LuckyBlocks.Teleports.Leave
		teleportTo(Leave.CFrame + Vector3.new(0, 5, 0))
		task.wait(9)
		teleportToBlockParty()
	end
	local function teleportToEgg(egg)
		if egg and egg:FindFirstChild("Part") then
			local targetCFrame = egg.Part.CFrame + Vector3.new(0, 5, 0)
			getHumanoidRootPart().CFrame = targetCFrame
			print("üìç Teleport ƒë·∫øn egg xa nh·∫•t:", egg.Name)
		end
	end

	local function isNearEgg(egg)
		local hrp = getHumanoidRootPart()
		local part = egg and egg:FindFirstChild("Part")
		if not part then return false end
		return (hrp.Position - part.Position).Magnitude < 15
	end

	local function safeHatchLoop(egg)
		while true do
			if not egg or not egg:IsDescendantOf(workspace) then
				warn("‚ùå Egg kh√¥ng t·ªìn t·∫°i n·ªØa.")
				break
			end

			if not isNearEgg(egg) then
				print("üö∂‚Äç‚ôÇÔ∏è Teleport l·∫°i ƒë·∫øn egg...")
				teleportToEgg(egg)
				task.wait(1)
			end

			local MaxEggHatch = EggCmds.GetMaxHatch()
			local args = {egg.Name, MaxEggHatch}
			local success, err = pcall(function()
				Network.CustomEggs_Hatch:InvokeServer(unpack(args))
			end)
			if not success then
				warn("‚ùå Hatch l·ªói:", err)
			end

			task.wait(0.5)
		end
	end

	-- üëâ B·∫Øt ƒë·∫ßu ch√≠nh:
while true do	
	local farthestEgg = findFarthestEgg()
	if farthestEgg then
		teleportToEgg(farthestEgg)
		task.wait(1)
		safeHatchLoop(farthestEgg)
		handleRejoin()
		task.wait(3)
	else
		warn("‚ùå Kh√¥ng t√¨m th·∫•y qu·∫£ tr·ª©ng n√†o.")
		handleRejoin()
		task.wait(3)
	end
	
end


end

---------------- üß© LU·ªíNG 4: Auto Summer Gift Bag 2025 ----------------
local function startAutoGiftBag()
    local function getCurrencyAmount(itemId)
        local Inventory = Save.Get().Inventory
        for _, v in pairs(Inventory.Misc) do 
            if v.id == itemId then
                return tonumber(v._am) or 0
            end
        end
        return 0
    end

    while true do
        waitUntilAllowed()

        if getTotalTileCount() >= 50 then
            local flowerCount = getCurrencyAmount("Tropical Flower")
            print("üå∫ Tropical Flower hi·ªán t·∫°i:", flowerCount)
            if flowerCount >= 10 then
                local args = {10}
                pcall(function()
                    Network.SummerGiftBag2025Machine_Activate:InvokeServer(unpack(args))
                    print("üéÅ ƒê√£ ƒë·ªïi 10 Tropical Flower th√†nh Gift Bag")
                end)
            end
        end

        task.wait(30)
    end
end

---------------- üß© LU·ªíNG 5: Auto Rebirth ----------------
local function startAutoRebirth()
	local PlotsInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Plots_Invoke")
	local threshold = 169
	local maxTileRebirth = 10

	while true do
		waitUntilAllowed()
		local saveData = Save.Get()
		local tileRebirth = saveData.TileRebirth or 0

		if tileRebirth >= maxTileRebirth then
			warn("üõë ƒê√£ ƒë·∫°t TileRebirth =", tileRebirth, "- D·ª´ng Auto Rebirth.")
			break
		end

		if getTotalTileCount() >= threshold then
			local args = {1, "Rebirth"}
			pcall(function()
				PlotsInvoke:InvokeServer(unpack(args))
				print("üîÅ ƒê√£ g·ª≠i y√™u c·∫ßu Rebirth | TileRebirth hi·ªán t·∫°i:", tileRebirth)
			end)
		end

		task.wait(2)
	end
end

---------------- üß© LU·ªíNG 6: GUI Coins / Tiles / Chance ----------------
local function startGuiUpdater()
	local player = Players.LocalPlayer
	local playerGui = player:WaitForChild("PlayerGui")

	local oldGui = playerGui:FindFirstChild("BlockPartyGui")
	if oldGui then
		oldGui:Destroy()
	end

	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "BlockPartyGui"
	screenGui.ResetOnSpawn = false
	screenGui.Parent = playerGui

	local function getCurrencyAmount(currencyId)
		local Inventory = Save.Get().Inventory
		for _, v in pairs(Inventory.Currency) do 
			if v.id == currencyId then
				return v._am
			end
		end
		return 0
	end

	local function createLabel(name, position, anchor, bgColor)
		local label = Instance.new("TextLabel")
		label.Name = name
		label.AnchorPoint = anchor
		label.Position = position
		label.Size = UDim2.new(0, 0, 0, 38)
		label.BackgroundColor3 = bgColor
		label.TextColor3 = Color3.new(1, 1, 1)
		label.Font = Enum.Font.GothamBold
		label.TextSize = 32
		label.BackgroundTransparency = 0
		label.BorderSizePixel = 0
		label.TextXAlignment = Enum.TextXAlignment.Center
		label.Text = "..."
		label.Parent = screenGui
		return label
	end

	local function updateLabelSize(label)
		label.Size = UDim2.new(0, label.TextBounds.X + 20, 0, 38)
	end

	local tilesLabel  = createLabel("TilesLabel",  UDim2.new(0, -10, 0.2, -10), Vector2.new(0, 0), Color3.fromRGB(0, 128, 0))
	local coinsLabel  = createLabel("CoinsLabel",  UDim2.new(0.5, -15, 0.2, -10), Vector2.new(0.5, 0), Color3.fromRGB(255, 165, 0))
	local chanceLabel = createLabel("ChanceLabel", UDim2.new(1, -30, 0.2, -10), Vector2.new(1, 0), Color3.fromRGB(0, 102, 204))

	while true do
		waitUntilAllowed()
		tilesLabel.Text  = "T: " .. tostring(getTotalTileCount())
		updateLabelSize(tilesLabel)

		coinsLabel.Text  = "C: " .. tostring(getCurrencyAmount("BlockPartyCoins"))
		updateLabelSize(coinsLabel)

		chanceLabel.Text = tostring(currentChance) .. "x HUGE"
		updateLabelSize(chanceLabel)

		task.wait(1)
	end
end


function check_joinevent_()
	
	m=0
	while true do
		task.wait(1)
		if getTotalTileCount() == 0 then
			m=m+1
		end
		if getTotalTileCount() ~= 0 then
			m=0
		end
		if m > 30 then
			local hrp = game.Players.LocalPlayer.Character.HumanoidRootPart
			hrp.CFrame = workspace.__THINGS.Instances.BlockParty.Teleports.Enter.CFrame + Vector3.new(0, 5, 0)
            task.wait(9)
			m=0			
		end
		task.wait(1)
	end

end

function check_Egghatch()

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Client = ReplicatedStorage:WaitForChild("Library"):WaitForChild("Client")
local SaveData = require(Client.Save).Get

local lastEggsHatched = nil

while true do
	task.wait(120)
	local data = SaveData()
	if data and data.EggsHatched then
		local current = data.EggsHatched

		if current == lastEggsHatched and getTotalTileCount() == 169 then
			Players.LocalPlayer:Kick("EggsHatched = 0")
			break
		end
		
		if getTotalTileCount() == 169 then
			lastEggsHatched = current
			warn(lastEggsHatched)
		end
	end

	task.wait(120)
end

end


---------------- üöÄ K√≠ch ho·∫°t t·∫•t c·∫£ lu·ªìng song song ----------------
local function startAllBlockPartyTasks()
	if isRunning then return end
	isRunning = true
	print("üöÄ ƒê√£ k√≠ch ho·∫°t startAllBlockPartyTasks")

	-- üß© LU·ªíNG 1: Auto Purchase
	task.spawn(function()
		local Save = require(ReplicatedStorage.Library.Client.Save)
		while true do
			local saveData = Save.Get()
			local tileRebirth = saveData.TileRebirth or 0
			local totalTiles = getTotalTileCount()

			if tileRebirth < 10 or totalTiles < 169 then
				print("‚úÖ ƒê√£ kh·ªüi ƒë·ªông LU·ªíNG 1: Auto Purchase")
				startAutoPurchase()
				break
			end
			task.wait(5)
		end
	end)

	-- üß© LU·ªíNG 2: Tile Handler
	task.spawn(function()
		print("‚úÖ ƒê√£ kh·ªüi ƒë·ªông LU·ªíNG 2: Tile Handler (Claim/Open/Unlock/Plant/Diamond)")
		startTileHandler()
	end)

	-- üß© LU·ªíNG 5: Hatch HUGE
	task.spawn(function()
		while true do
			while getTotalTileCount() < 83 do
				task.wait(2)
			end
			print("‚úÖ ƒê√£ kh·ªüi ƒë·ªông LU·ªíNG 3: Hatch HUGE CHANCE")
			startAutoHatchFarthest()
		end
	end)

	-- üß© LU·ªíNG 6: Auto Gift Bag
	task.spawn(function()
		while true do
			while getTotalTileCount() < 50 do
				task.wait(2)
			end
			print("‚úÖ ƒê√£ kh·ªüi ƒë·ªông LU·ªíNG 4: Auto SummerGiftBag2025")
			startAutoGiftBag()
		end
	end)

	-- üß© LU·ªíNG 7: Auto Rebirth
	task.spawn(function()
		local Save = require(ReplicatedStorage.Library.Client.Save)
		while true do
			local saveData = Save.Get()
			local tileRebirth = saveData.TileRebirth or 0
			if tileRebirth < 10 then
				print("‚úÖ ƒê√£ kh·ªüi ƒë·ªông LU·ªíNG 5: Auto Rebirth")
				startAutoRebirth()
				break
			end
			task.wait(5)
		end
	end)

	-- üß© LU·ªíNG 8: GUI Updater
	task.spawn(function()
		print("‚úÖ ƒê√£ kh·ªüi ƒë·ªông LU·ªíNG 6: GUI Updater")
		startGuiUpdater()
	end)
	task.spawn(function()
		print("‚úÖ ƒê√£ kh·ªüi check_joinevent_")
		check_joinevent_()
	end)
	task.spawn(function()
		print("‚úÖ ƒê√£ kh·ªüi check_Egghatch")
		check_Egghatch()
	end)
end

task.spawn(function()
	while true do
		if _G.VAR_STOP_BLOCK_PARTY and _G.VAR_BLOCK_PARTY then
			isRunning = false
		end

		if _G.VAR_START_BLOCK_PARTY and not isRunning then
			startAllBlockPartyTasks()
		end

		task.wait(2)
	end
end)
