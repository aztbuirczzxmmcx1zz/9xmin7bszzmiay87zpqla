import os
import time
import subprocess
import pyautogui
import re

LDPLAYER_MULTIPLAYER_PATH = r"C:\LDPlayer\LDPlayer9\dnmultiplayer.exe"
BACKUP_APP_PATH = r"C:\Users\ADMIN\Desktop\backupldplayer.exe"
DISK_ACTIVITY_COUNTER = r'\LogicalDisk(C:)\% Disk Time'
DISK_ACTIVITY_THRESHOLD = 5.0
STARTUP_DELAY_AFTER_BACKUP = 10
MAX_WAIT_TIME_DISK_CHECK = 3600
EMURB_PATH = r"C:\Users\ADMIN\Downloads\Yummyemu\YummyEmuPlayer\EmuRB.exe"
#INITIAL_COUNTDOWN_SECONDS = 30


def open_application(app_path):
    if not os.path.isfile(app_path):
        print(f"❌ LỖI: Không tìm thấy file ứng dụng tại: {app_path}")
        return False

    subprocess.Popen([app_path], cwd=os.path.dirname(app_path))
    return True


def run_modified_ldplayer_sequence():
    print("\n[PHẦN KHỞI CHẠY ĐÃ SỬA] Bắt đầu gọi lại LDMultiplayer và Click cuối cùng...")

    try:
        print(f"Gọi lại ứng dụng LDMultiplayer: {LDPLAYER_MULTIPLAYER_PATH}")
        subprocess.Popen(LDPLAYER_MULTIPLAYER_PATH)
        time.sleep(5)
    except FileNotFoundError:
        print(f"LỖI: Không tìm thấy đường dẫn ứng dụng: {LDPLAYER_MULTIPLAYER_PATH}")
        return

    CLICK_SEQUENCE_FINAL = [
        (650, 749),
        (651, 380),
        (783, 749),
        (798, 656),
        (1236, 272)
    ]

    for i, (x, y) in enumerate(CLICK_SEQUENCE_FINAL):
        print(f"Click khởi chạy {i + 1}: ({x}, {y})")
        pyautogui.click(x, y)
        time.sleep(1)

    print("\n[PHẦN KHỞI CHẠY ĐÃ SỬA KẾT THÚC] Đã hoàn thành quy trình LDPlayer.")


def run_emurb_sequence():
    print("\n[BẮT ĐẦU PHẦN EMURB] Khởi động chuỗi hành động EmuRB.")

    for i in range(INITIAL_COUNTDOWN_SECONDS, 0, -10):
        print(f"\rChờ: Còn lại {i} s...", end='', flush=True)
        time.sleep(10)

    if not open_application(EMURB_PATH):
        return

    time.sleep(15)

    pyautogui.click(406, 192)
    time.sleep(1)
    pyautogui.click(406, 192)
    time.sleep(2)

    pyautogui.press("3")
    time.sleep(2)

    pyautogui.press("enter")
    time.sleep(20)

    pyautogui.press("enter")

    pyautogui.press("1")
    time.sleep(2)

    pyautogui.press("enter")
    time.sleep(5)

    pyautogui.click(630, 711)
    time.sleep(1)
    pyautogui.click(744, 699)
    time.sleep(1)
    pyautogui.click(744, 699)
    time.sleep(2)

    pyautogui.press("enter")
    time.sleep(40)

    pyautogui.press("enter")
    time.sleep(2)

    pyautogui.click(1288, 305)
    time.sleep(2)
    pyautogui.click(1288, 305)
    time.sleep(2)

    pyautogui.click(595, 131)
    time.sleep(2)
    pyautogui.click(595, 131)
    time.sleep(2)

    pyautogui.press("2")
    time.sleep(1)

    pyautogui.press("enter")

    print("\n[PHẦN EMURB KẾT THÚC] Chuỗi hành động EmuRB đã hoàn tất.")


if __name__ == "__main__":
    run_modified_ldplayer_sequence()
    run_emurb_sequence()
    print("\n[KẾT THÚC] Toàn bộ quy trình tự động hóa đã hoàn tất.")
