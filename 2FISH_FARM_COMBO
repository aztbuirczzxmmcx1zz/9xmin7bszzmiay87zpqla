local Save = require(game:GetService("ReplicatedStorage").Library.Client.Save)
local rank = Save.Get().Rank
check_map = Save.Get().UnlockedZones

local MAP_w2_true = check_map["Tech Spawn"]
local MAP_w3_true = check_map["Prison HQ"]
local MAP_w4_true = check_map["Fantasy Spawn"]

if not MAP_w2_true then
	if game.PlaceId == 95635359880599 or game.PlaceId == 119454325063278 then
		local Players = game:GetService("Players")
		local TeleportService = game:GetService("TeleportService")
		TeleportService:Teleport(8737899170, LocalPlayer)
		wait(10)
	end
    return
elseif not MAP_w3_true then
	if game.PlaceId == 95635359880599 or game.PlaceId == 119454325063278 then
		local Players = game:GetService("Players")
		local TeleportService = game:GetService("TeleportService")
		TeleportService:Teleport(16498369169, LocalPlayer)
		wait(10)
	end
    return
elseif not MAP_w4_true then
	if game.PlaceId == 95635359880599 or game.PlaceId == 119454325063278 then
		local Players = game:GetService("Players")
		local TeleportService = game:GetService("TeleportService")
		TeleportService:Teleport(17503543197, LocalPlayer)
		wait(10)
	end
    return
end



local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local LocalPlayer = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

local okSave, Save = pcall(function() return require(ReplicatedStorage.Library.Client.Save) end)
if not okSave then Save = nil end

local FARM_PLACEID = 95635359880599		--119454325063278
local FISH_PLACEID = 119454325063278	--95635359880599

local LOBBY_PLACEID_SPECIAL = 140403681187145 
local WORLD4_REMOTE_NAME = "World4Teleport"
local REQUIRED_SECONDS = 30 * 60 

local runtime = {
    farm = { total = 1800, last = os.time(), done = true },
    fish = { total = 1800, last = os.time(), done = true },
    lastDay = os.date("%d/%m/%Y"),
    reset23Date = nil
}

local function getFileName() return "comboEventLog.json" end

local function loadData()
    if isfile(getFileName()) then
        local ok, data = pcall(function() return HttpService:JSONDecode(readfile(getFileName())) end)
        if ok and type(data) == "table" then
            runtime = data
            runtime.farm = runtime.farm or { total = 0, last = os.time(), done = false }
            runtime.fish = runtime.fish or { total = 0, last = os.time(), done = false }

            -- ?? Check l?i tr?ng thái done n?u b? thi?u
            local updated = false
			if not runtime.farm.done and runtime.farm.total >= REQUIRED_SECONDS then
				runtime.farm.done = true
				updated = true
			end
			if not runtime.fish.done and runtime.fish.total >= REQUIRED_SECONDS then
				runtime.fish.done = true
				updated = true
			end

			if updated then
				saveData()
			end

            runtime.lastDay = runtime.lastDay or os.date("%d/%m/%Y")
        end
    end
end



local function saveData()
    runtime.lastDay = os.date("%d/%m/%Y")
    task.spawn(function()
        local success, err = pcall(function()
            writefile(getFileName(), HttpService:JSONEncode(runtime))
        end)
        if not success then
            warn("? Ghi file th?t b?i:", err)
        end
    end)
end

task.spawn(function()
    while true do
        task.wait(60)
        saveData()
    end
end)

local function resetIfNewDay()
    local today = os.date("%d/%m/%Y")
    if runtime.lastDay ~= today then
		runtime.farm.done = false
		runtime.fish.done = false
		
        runtime.lastDay = today
        runtime.reset23Date = nil

        for _, key in pairs({ "farm", "fish" }) do
            runtime[key].total = 0
            runtime[key].last = os.time()
            runtime[key].done = false
        end

        warn("?? Reset vì sang ngày m?i:", today)
        saveData()
		
    end
end


local function getVNNow()
    local now = os.date("!*t", os.time(os.date("!*t")) + 7 * 3600)
    return now
end

local function checkResetAt23()
    local vn = getVNNow()
    if not vn then return end
    local vnDateStr = string.format("%02d/%02d/%04d", vn.day, vn.month, vn.year)
    if vn.hour == 23 then
        if runtime.reset23Date ~= vnDateStr then
            runtime.farm.total = 0
            runtime.farm.last = os.time()
            runtime.farm.done = false
            runtime.fish.total = 0
            runtime.fish.last = os.time()
            runtime.fish.done = false
            runtime.reset23Date = vnDateStr
            runtime.lastDay = vnDateStr
            saveData()
            warn(("?? Reset progress at 23:00 VN (%s)"):format(vnDateStr))
        end
    else
        -- do nothing; reset23Date kept until new day or next 23:00
    end
end

local function updateProgress(which)
    local now = os.time()
    local data = runtime[which]
    if not data then 
		--warn("[updateProgress] Không tìm th?y runtime." .. which) 
		return 
	end
    if type(data.last) ~= "number" then
        --warn("[updateProgress] last b? l?i, gán l?i")
        data.last = now
    end

    local delta = math.max(0, now - data.last)
    data.total = (data.total or 0) + delta
    data.last = now

    --warn(string.format("[updateProgress] %s: +%ds, total=%d", which, delta, data.total))

    if not data.done and data.total >= REQUIRED_SECONDS then
        data.done = true
        warn(string.format("[updateProgress] %s DONE ?", which))
    end

    local success, err = pcall(function()
        writefile(getFileName(), HttpService:JSONEncode(runtime))
    end)
    if not success then
        --warn("[updateProgress] ? Ghi file th?t b?i:", err)
    else
        --warn("[updateProgress] ? Ðã luu vào file")
    end
end



local function createGUI()
    if PlayerGui:FindFirstChild("EventProgressUI") then PlayerGui.EventProgressUI:Destroy() end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "EventProgressUI"
    screenGui.Parent = PlayerGui

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 250, 0, 68)
    frame.Position = UDim2.new(0, 10, 1, -60)
    frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
    frame.BackgroundTransparency = 1
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

    local function createRow(parent, text, y, color)
        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(1, -10, 0, 20)
        lbl.Position = UDim2.new(0,5,0,y)
        lbl.BackgroundTransparency = 1
        lbl.TextColor3 = Color3.fromRGB(230,230,230)
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.Font = Enum.Font.SourceSansBold
        lbl.TextSize = 26
        lbl.Text = text .. ": 0%"
        lbl.Parent = parent

        local bg = Instance.new("Frame")
        bg.Size = UDim2.new(1, -10, 0, 12)
        bg.Position = UDim2.new(0,5,0,y + 22)
        bg.BackgroundColor3 = Color3.fromRGB(60,60,60)
        bg.BorderSizePixel = 0
        bg.Parent = parent
        Instance.new("UICorner", bg).CornerRadius = UDim.new(0,6)

        local bar = Instance.new("Frame")
        bar.Size = UDim2.new(0,0,1,0)
        bar.BackgroundColor3 = color
        bar.BorderSizePixel = 0
        bar.Parent = bg
        Instance.new("UICorner", bar).CornerRadius = UDim.new(0,6)

        return lbl, bar
    end

    local farmLbl, farmBar = createRow(frame, "Fishing", 5, Color3.fromRGB(100,255,100))
    local fishLbl, fishBar = createRow(frame, "Farm", 36, Color3.fromRGB(100,150,255))

    task.spawn(function()
        while screenGui.Parent do
            local farmPct = math.min(100, math.floor((runtime.farm.total or 0) / REQUIRED_SECONDS * 100))
            local fishPct = math.min(100, math.floor((runtime.fish.total or 0) / REQUIRED_SECONDS * 100))

            farmLbl.Text = string.format("Fishing: %d%%", farmPct)
            farmBar.Size = UDim2.new(farmPct/100, 0, 1, 0)

            fishLbl.Text = string.format("Farm: %d%%", fishPct)
            fishBar.Size = UDim2.new(fishPct/100, 0, 1, 0)

            task.wait(30)
        end
    end)
end


local function invokeWorld4()

	if game.PlaceId ~= 140403681187145 then
    	game:GetService("ReplicatedStorage"):WaitForChild("Network"):WaitForChild("World4Teleport"):InvokeServer()
	    task.wait(20) 
	end

    if game.PlaceId ~= 140403681187145 then
        game:GetService("ReplicatedStorage"):WaitForChild("Network"):WaitForChild("World4Teleport"):InvokeServer()
        task.wait(30)
				if game.PlaceId ~= 140403681187145 then
					LocalPlayer:Kick("tele World4 FAIL")
				end
    end
end

local function serverhopTo(placeId)
	wait(7)
	TeleportService:Teleport(placeId, LocalPlayer)
	wait(30)
	if game.PlaceId ~= placeId then
		LocalPlayer:Kick("tele placeId FAIL")
	end
end

local function serverhopToFishing()
	if game.PlaceId ~= FISH_PLACEID then
		serverhopTo(FISH_PLACEID)
	end
end
local function serverhopToFarm()
	if game.PlaceId ~= FARM_PLACEID then
		serverhopTo(FARM_PLACEID)		
	end
end
local function teleportToFishingInServer()
	if game.PlaceId ~= FISH_PLACEID then
		serverhopTo(FISH_PLACEID)
	end
end
local function teleportToFarmInServer()
	if game.PlaceId ~= FARM_PLACEID then
		serverhopTo(FARM_PLACEID)
	end
end


local function trackFarm()
    task.spawn(function()
        while not runtime.farm.done do
            updateProgress("farm")
            task.wait(10)
        end
        if not runtime.fish.done then
            pcall(serverhopToFishing)
        end
		if runtime.farm.done and runtime.fish.done then
			game:Shutdown()
			LocalPlayer:Kick("kick_compo_track_farm")
		end
    end)
end

local function trackFishing()
    task.spawn(function()
        while not runtime.fish.done do
            updateProgress("fish")
            task.wait(10)
        end
        if not runtime.farm.done then
            pcall(serverhopToFarm)
        end
    end)
end

local function waitForNewDay()
    local initial = os.date("%d/%m/%Y")
    while true do
        task.wait(60)
        if os.date("%d/%m/%Y") ~= initial then
            resetIfNewDay()
            break
        end
    end
end

task.spawn(function()
    while true do
        pcall(function() checkResetAt23() end)
        task.wait(60)
    end
end)



local function main()

    loadData()
    resetIfNewDay()

    task.spawn(function()
        task.wait(60)
        pcall(createGUI)
    end)
    
    if runtime.farm.done and runtime.fish.done then
        invokeWorld4()
        return
    end

    if game.PlaceId == FARM_PLACEID then
        runtime.farm.last = os.time()
        saveData()
        if (not runtime.farm.done) and (not runtime.fish.done) then
            local okHop = pcall(serverhopToFishing)
            if not okHop then teleportToFishingInServer() end
            return
        end
        if (not runtime.farm.done) and runtime.fish.done then
            trackFarm()
            return
        end
        if runtime.farm.done and (not runtime.fish.done) then
            local okHop = pcall(serverhopToFishing)
            if not okHop then teleportToFishingInServer() end
            return
        end
    end

    if game.PlaceId == FISH_PLACEID then
        runtime.fish.last = os.time()
        saveData()
        if not runtime.fish.done then
            trackFishing()
            return
        end
        if not runtime.farm.done then
            local okHop = pcall(serverhopToFarm)
            if not okHop then teleportToFarmInServer() end
            return
        end
    end

    if (not runtime.fish.done) and (not runtime.farm.done) then
        local okHop = pcall(serverhopToFishing)
        if not okHop then teleportToFishingInServer() end
        return
    end

    if runtime.fish.done and (not runtime.farm.done) then
        local okHop = pcall(serverhopToFarm)
        if not okHop then teleportToFarmInServer() end
        return
    end

    if runtime.farm.done and (not runtime.fish.done) then
        local okHop = pcall(serverhopToFishing)
        if not okHop then teleportToFishingInServer() end
        return
    end
end

pcall(main)
